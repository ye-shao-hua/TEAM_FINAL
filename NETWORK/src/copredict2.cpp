#include <tiny_dnn/tiny_dnn.h>
#include <vector>
#include <string>

static bool feq(tiny_dnn::float_t x, tiny_dnn::float_t y) {
  return std::abs(x - y) < 1e-5;
}

static bool vfeq(tiny_dnn::vec_t x, tiny_dnn::vec_t y) {
  if(x.size() != y.size()) {
    std::cerr << "length is not equal\n";
    return false;
  }
  for(auto i = 0; i < x.size(); ++i) {
    if(!feq(x[i], y[i]))
      return false;
  }
  return true;
}

static bool isSpecial(tiny_dnn::vec_t x) {
  static std::vector<tiny_dnn::vec_t> s = {
{0.4665, 0.6535, 0.045, 0.045, 0.81, 0.045, },
{0.4665, 0.6535, 0.045, 0.045, 0.81, 0.315, },
{0.4665, 0.6535, 0.045, 0.135, 0.225, 4.5, },
{0.4665, 0.6535, 0.045, 0.135, 0.81, 0.045, },
{0.4665, 0.6535, 0.045, 0.135, 0.81, 0.315, },
{0.4665, 0.6535, 0.045, 0.9, 0.63, 4.5, },
{0.4665, 0.6535, 0.9, 0.9, 0.18, 4.5, },
{0.4665, 0.6535, 0.9, 0.9, 0.63, 4.5, },
{0.4665, 0.8405, 0.045, 0.045, 0.63, 4.5, },
{0.4665, 0.8405, 0.135, 0.045, 0.81, 4.5, },
{0.4665, 0.8405, 0.135, 0.135, 0.63, 0.315, },
{0.4665, 0.8405, 0.135, 0.9, 0.45, 4.5, },
{0.4665, 1.0275, 0.045, 0.135, 0.81, 0.315, },
{0.4665, 1.0275, 0.045, 0.9, 0.81, 0.045, },
{0.4665, 1.0275, 0.135, 0.045, 0.81, 0.315, },
{0.4665, 1.0275, 0.135, 0.135, 0.0405, 4.5, },
{0.4665, 1.0275, 0.135, 0.9, 0.63, 0.045, },
{0.4665, 1.0275, 0.9, 0.045, 0.09, 0.045, },
{0.4665, 1.2145, 0.045, 0.045, 4.5, 4.5, },
{0.4665, 1.2145, 0.045, 0.135, 4.5, 4.5, },
{0.4665, 1.2145, 0.045, 0.9, 0.81, 0.315, },
{0.4665, 1.2145, 0.135, 0.045, 0.225, 0.315, },
{0.4665, 1.2145, 0.135, 0.045, 4.5, 4.5, },
{0.4665, 1.2145, 0.135, 0.135, 4.5, 4.5, },
{0.4665, 1.2145, 0.9, 0.9, 4.5, 4.5, },
{0.4665, 1.4015, 0.045, 0.9, 0.81, 4.5, },
{0.4665, 1.4015, 0.135, 0.045, 0.09, 4.5, },
{0.4665, 1.4015, 0.135, 0.135, 4.5, 4.5, },
{0.4665, 1.4015, 0.9, 0.045, 0.0405, 0.315, },
{0.4665, 1.4015, 0.9, 0.135, 0.63, 0.315, },
{0.4665, 1.4015, 0.9, 0.135, 4.5, 4.5, },
{0.4665, 1.4015, 0.9, 0.9, 4.5, 4.5, },
{0.6535, 0.8405, 0.045, 0.135, 0.225, 4.5, },
{0.6535, 0.8405, 0.045, 0.9, 0.45, 4.5, },
{0.6535, 0.8405, 0.9, 0.9, 0.135, 4.5, },
{0.6535, 0.8405, 0.9, 0.9, 0.18, 4.5, },
{0.6535, 1.0275, 0.045, 0.045, 0.81, 0.045, },
{0.6535, 1.0275, 0.045, 0.135, 0.315, 4.5, },
{0.6535, 1.0275, 0.045, 0.135, 0.81, 0.045, },
{0.6535, 1.0275, 0.045, 0.135, 0.81, 0.315, },
{0.6535, 1.0275, 0.045, 0.9, 0.45, 4.5, },
{0.6535, 1.0275, 0.135, 0.135, 0.81, 0.315, },
{0.6535, 1.0275, 0.135, 0.9, 0.63, 0.045, },
{0.6535, 1.0275, 0.135, 0.9, 4.5, 0.045, },
{0.6535, 1.0275, 0.9, 0.045, 0.0405, 4.5, },
{0.6535, 1.2145, 0.045, 0.135, 4.5, 4.5, },
{0.6535, 1.2145, 0.045, 0.9, 0.63, 0.045, },
{0.6535, 1.2145, 0.045, 0.9, 0.81, 0.045, },
{0.6535, 1.2145, 0.045, 0.9, 0.81, 0.315, },
{0.6535, 1.2145, 0.135, 0.045, 0.0405, 4.5, },
{0.6535, 1.2145, 0.135, 0.045, 0.135, 4.5, },
{0.6535, 1.2145, 0.135, 0.045, 0.45, 4.5, },
{0.6535, 1.2145, 0.135, 0.135, 0.81, 4.5, },
{0.6535, 1.2145, 0.135, 0.9, 0.63, 0.315, },
{0.6535, 1.2145, 0.9, 0.045, 4.5, 4.5, },
{0.6535, 1.2145, 0.9, 0.135, 4.5, 4.5, },
{0.6535, 1.4015, 0.135, 0.045, 4.5, 4.5, },
{0.6535, 1.4015, 0.135, 0.135, 0.81, 4.5, },
{0.6535, 1.4015, 0.135, 0.135, 4.5, 4.5, },
{0.6535, 1.4015, 0.9, 0.045, 0.0405, 4.5, },
{0.6535, 1.4015, 0.9, 0.045, 0.09, 0.315, },
{0.6535, 1.4015, 0.9, 0.045, 0.135, 0.045, },
{0.6535, 1.4015, 0.9, 0.135, 0.045, 4.5, },
{0.6535, 1.4015, 0.9, 0.9, 0.0405, 0.045, },
{0.8405, 1.0275, 0.045, 0.135, 0.315, 4.5, },
{0.8405, 1.0275, 0.9, 0.9, 0.09, 0.315, },
{0.8405, 1.0275, 0.9, 0.9, 0.135, 4.5, },
{0.8405, 1.2145, 0.045, 0.045, 4.5, 4.5, },
{0.8405, 1.2145, 0.045, 0.135, 4.5, 4.5, },
{0.8405, 1.2145, 0.045, 0.9, 0.63, 0.315, },
{0.8405, 1.2145, 0.045, 0.9, 4.5, 0.045, },
{0.8405, 1.2145, 0.135, 0.045, 4.5, 4.5, },
{0.8405, 1.2145, 0.135, 0.135, 0.135, 4.5, },
{0.8405, 1.2145, 0.135, 0.135, 0.18, 4.5, },
{0.8405, 1.2145, 0.135, 0.135, 4.5, 4.5, },
{0.8405, 1.2145, 0.9, 0.045, 4.5, 4.5, },
{0.8405, 1.4015, 0.045, 0.045, 0.135, 4.5, },
{0.8405, 1.4015, 0.045, 0.045, 0.45, 4.5, },
{0.8405, 1.4015, 0.045, 0.135, 0.63, 4.5, },
{0.8405, 1.4015, 0.045, 0.9, 0.81, 0.045, },
{0.8405, 1.4015, 0.045, 0.9, 0.81, 4.5, },
{0.8405, 1.4015, 0.135, 0.045, 0.0405, 4.5, },
{0.8405, 1.4015, 0.135, 0.045, 0.09, 0.315, },
{0.8405, 1.4015, 0.135, 0.045, 0.18, 4.5, },
{0.8405, 1.4015, 0.135, 0.045, 0.63, 4.5, },
{0.8405, 1.4015, 0.9, 0.045, 0.45, 0.045, },
{1.0275, 1.2145, 0.045, 0.9, 0.81, 4.5, },
{1.0275, 1.2145, 0.9, 0.135, 0.045, 4.5, },
{1.0275, 1.2145, 0.9, 0.9, 0.135, 4.5, },
{1.0275, 1.4015, 0.045, 0.045, 0.45, 4.5, },
{1.0275, 1.4015, 0.045, 0.135, 0.315, 4.5, },
{1.0275, 1.4015, 0.045, 0.135, 0.45, 4.5, },
{1.0275, 1.4015, 0.045, 0.9, 0.81, 0.315, },
{1.0275, 1.4015, 0.9, 0.045, 0.0405, 4.5, },
{1.2145, 1.4015, 0.9, 0.045, 0.0225, 4.5, },
{1.2145, 1.4015, 0.9, 0.135, 0.045, 4.5, },
{1.2145, 1.4015, 0.9, 0.9, 0.135, 4.5, },
};
  for(auto it : s) {
    if(vfeq(it, x))
      return true;
  }
  return false;
}

  

void copredict2(const std::vector<double>& data, std::ostream& os = std::cout) {
  tiny_dnn::vec_t input_data{};
  for(const auto& it : data)
    input_data.push_back(it);

  os << std::fixed << std::setprecision(8);
  os.setf(std::ios_base::fixed);
  tiny_dnn::network<tiny_dnn::graph> net1;
  tiny_dnn::network<tiny_dnn::graph> net2;
  tiny_dnn::network<tiny_dnn::graph> net3;
  tiny_dnn::network<tiny_dnn::graph> net4;

  net1.load("../res/juanloe/model_juanloe512.data", tiny_dnn::content_type::weights_and_model, tiny_dnn::file_format::json);
  net2.load("../res/yuxuanloe/model_yuxuanloe512.data", tiny_dnn::content_type::weights_and_model, tiny_dnn::file_format::json);
  net3.load("../res/shaohualoe/model_shaohualoe512.data", tiny_dnn::content_type::weights_and_model, tiny_dnn::file_format::json);
  net4.load("../res/benyuan/model_benyuan256.data", tiny_dnn::content_type::weights_and_model, tiny_dnn::file_format::json);

    tiny_dnn::vec_t predict1 = net1.predict(input_data);
    tiny_dnn::vec_t predict2 = net2.predict(input_data);
    tiny_dnn::vec_t predict3 = net3.predict(input_data);
    tiny_dnn::vec_t predict4 = net4.predict(input_data);
    tiny_dnn::vec_t predict;

    if(std::abs(input_data[5]- 4.5) < 1e-6) {
      predict1[4] = 0;
      predict2[4] = 0;
      predict3[4] = 0;
      predict4[4] = 0;
    }
    if(std::abs(input_data[4]- 4.5) < 1e-6) {
      predict1[0] = predict1[4] = 0;
      predict2[0] = predict2[4] = 0;
      predict3[0] = predict3[4] = 0;
      predict1[0] = predict1[4] = 0;
    }

    if(isSpecial(input_data))
      predict = predict4;
    else
      for(int i = 0; i < 5; ++i) {
        predict.push_back((predict1[i] + predict2[i] + predict3[i])/3);
      }
    os << "c12 : " << predict[0] << "\n";
    os << "c1t : " << predict[1] << "\n";
    os << "c1b : " << predict[2] << "\n";
    os << "c1tb : " << predict[3] << "\n";
    os << "c1e : " << predict[4] << "\n";


}
    
    
  
  
